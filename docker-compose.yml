version: '3.8'

services:
    postgres:
        image: postgres:11-alpine
        container_name: eco-zubr-postgres

        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: postgres

        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql

        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5

        networks:
            - app-network

    app:
        build: .
        container_name: eco-zubr-app

        environment:
            SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
            SPRING_DATASOURCE_USERNAME: ${DB_USER}
            SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
            SPRING_JPA_HIBERNATE_DDL_AUTO: update
            MAX_TOKEN: ${MAX_TOKEN}
            YANDEX_GEOCODER_TOKEN: ${YANDEX_GEOCODER_TOKEN}


        depends_on:
            postgres:
                condition: service_healthy

        networks:
            - app-network

volumes:
    postgres_data:

networks:
    app-network:
        driver: bridge

